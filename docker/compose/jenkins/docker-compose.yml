version: '3.7'

networks:
  pipelines:
    name: ${NETWORK_NAME:-hv-pipelines}

volumes:
  home:
    name: ${VOLUME_NAME:-hv-jenkins-home}

services:
  master:
    image: ${MASTER_IMAGE_NAME:-hv/jenkins-master}
    build:
      context: ../../jenkins
      dockerfile: Dockerfile-master
      args:
        - uid=${UID:-1000}
        - gid=${GID:-1000}
        - JENKINS_VERSION=${JENKINS_VERSION}
    environment:
      - MASTER_LABELS=${MASTER_LABELS:-master}
    volumes:
      - home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CREDENTIALS:-./credentials}:/usr/share/jenkins/secrets/credentials
      - ${PROJECTS_DIR:-./projects}:/projects
    networks:
      - pipelines
    ports:
      - ${PORT:-8080}:8080
  agent:
    image: ${AGENT_IMAGE_NAME:-hv/jenkins-agent}
    build:
      context: ../../jenkins-agent
      args:
        - uid=${UID:-1000}
        - gid=${GID:-1000}
    command: -master http://master:8080 -fsroot /var/jenkins_home -executors ${AGENT_EXECUTORS:-2} -name agent -labels ${AGENT_LABELS:-non-master}
    volumes:
      - home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - ${PROJECTS_DIR:-./projects}:/projects
    networks:
      - pipelines
